<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản Lý Nhân Sự - LSPD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <head><body>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const me = JSON.parse(localStorage.getItem("lspd_me") || "{}");

  // Nếu không phải Admin -> quay về dashboard
  if (me.role !== "Admin") {
    alert("Bạn không có quyền truy cập trang này!");
    location.href = "dashboard.html";
  }
});
</script>

  </body></head>
  <style>
    body {
      background:url('background.jpg') no-repeat center center fixed;
      background-size:cover;
    }
    .content-box {
      background:rgba(255,255,255,0.9);
      padding:20px;
      border-radius:10px;
      box-shadow:0 0 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="dashboard.html">Trang Chủ</a></li>
        <li class="nav-item"><a class="nav-link" href="duty.html">Chấm Công</a></li>
        <li class="nav-item"><a class="nav-link" href="bail.html">Bảo Lãnh</a></li>
        <li class="nav-item"><a class="nav-link" href="support.html">Xử Án</a></li>
        <li class="nav-item"><a class="nav-link" href="wanted.html">Truy Nã</a></li>
        <li class="nav-item"><a class="nav-link" href="wanted.html">Bảo Lãnh</a></li>
        <li class="nav-item"><a class="nav-link" href="leave.html">Nghỉ Phép</a></li>
        <li class="nav-item"><a class="nav-link" href="salary.html">💰 Hệ Số Lương</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">Quản Lý</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="manage.html">👮 Nhân Sự</a></li>
            <li><a class="dropdown-item" href="salary.html">💰 Hệ Số Lương</a></li>
            <li><a class="dropdown-item" href="timekeeping.html">🕒 Công/Lương</a></li>
            <li><a class="dropdown-item active" href="tasks.html">⚙️ Tác Vụ Chung</a></li>
          </ul>
        </li>
      </ul>
      <a href="#" id="btnLogout" class="btn btn-outline-warning btn-sm">Đăng xuất</a>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="content-box">
    <h2 class="mb-3">📋 Quản Lý Nhân Sự</h2>

    <!-- Form thêm -->
    <form id="addUserForm" class="row g-3 mb-4">
      <div class="col-md-4"><input type="text" id="username" class="form-control" placeholder="Tên đăng nhập" required></div>
      <div class="col-md-4"><input type="password" id="password" class="form-control" placeholder="Mật khẩu" required></div>
      <div class="col-md-4"><input type="text" id="name" class="form-control" placeholder="Họ và tên sĩ quan" required></div>

      <div class="col-md-3">
        <select id="role" class="form-select">
          <option value="User">Nhân Viên</option>
          <option value="Admin">Quản Trị Viên</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="position" class="form-select">
          <option value="Giám Đốc">Giám Đốc</option>
          <option value="Phó Giám Đốc">Phó Giám Đốc</option>
          <option value="Trợ Lý Giám Đốc">Trợ Lý Giám Đốc</option>
          <option value="Thư ký">Thư ký</option>
          <option value="Đội trưởng">Đội trưởng</option>
          <option value="Phó đội trưởng">Phó đội trưởng</option>
          <option value="Cảnh sát viên">Cảnh sát viên</option>
          <option value="Thực Tập">Thực Tập</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="rank" class="form-select">
          <option value="Đại tá">Đại tá</option>
          <option value="Thượng tá">Thượng tá</option>
          <option value="Trung tá">Trung tá</option>
          <option value="Thiếu tá">Thiếu tá</option>
          <option value="Đại úy">Đại úy</option>
          <option value="Thượng úy">Thượng úy</option>
          <option value="Trung úy">Trung úy</option>
          <option value="Thiếu úy">Thiếu úy</option>
          <option value="Thượng sĩ">Thượng sĩ</option>
          <option value="Trung sĩ">Trung sĩ</option>
          <option value="Hạ sĩ">Hạ sĩ</option>
        </select>
      </div>
      <div class="col-md-3"><input type="number" id="rate" class="form-control" placeholder="Lương/giờ" value="50"></div>

      <div class="col-12 text-end"><button type="submit" class="btn btn-primary">➕ Thêm nhân sự</button></div>
    </form>

    <!-- Search + Export + History + Trash -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <input type="text" id="searchUser" placeholder="🔎 Tìm sĩ quan hoặc tài khoản..." class="form-control w-50">
      <div>
        <button onclick="exportExcel()" class="btn btn-success">📥 Xuất Excel</button>
        <button class="btn btn-info" onclick="showHistory()">🕘 Lịch Sử</button>
        <button class="btn btn-warning" onclick="showTrash()">🗑 Thùng Rác</button>
      </div>
    </div>

    <!-- Bảng -->
    <div class="table-responsive">
      <table id="usersTbl" class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
              <tr>
                <th>STT</th><th>Tài khoản</th><th>Tên sĩ quan</th>
                <th>Vai trò</th><th>Chức vụ</th><th>Quân hàm</th><th>Lương/giờ</th><th>Hành động</th>
              </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal lịch sử -->
<div class="modal fade" id="historyModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">🕘 Lịch Sử Hoạt Động</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><ul id="historyList" class="list-group"></ul></div>
  </div></div>
</div>

<!-- Modal thùng rác -->
<div class="modal fade" id="trashModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">🗑 Nhân Sự Trong Thùng Rác</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <table class="table table-striped"><thead><tr><th>Tài khoản</th><th>Tên</th><th>Chức vụ</th><th>Thao tác</th></tr></thead><tbody id="trashList"></tbody></table>
    </div>
  </div></div>
</div>

<script>
const posOrder = {"Giám Đốc":1,"Phó Giám Đốc":2,"Trợ Lý Giám Đốc":3,"Thư ký":4,"Đội trưởng":5,"Phó đội trưởng":6,"Cảnh sát viên":7,"Thực Tập":8};
const rankOrder={"Đại tá":1,"Thượng tá":2,"Trung tá":3,"Thiếu tá":4,"Đại úy":5,"Thượng úy":6,"Trung úy":7,"Thiếu úy":8,"Thượng sĩ":9,"Trung sĩ":10,"Hạ sĩ":11};

function getUsers(){return JSON.parse(localStorage.getItem("lspd_users")||"[]");}
function setUsers(arr){localStorage.setItem("lspd_users",JSON.stringify(arr));}
function getTrash(){return JSON.parse(localStorage.getItem("lspd_trash")||"[]");}
function setTrash(arr){localStorage.setItem("lspd_trash",JSON.stringify(arr));}
function getHistory(){return JSON.parse(localStorage.getItem("lspd_history")||"[]");}
function pushHistory(msg){let h=getHistory();h.push(msg+" - "+new Date().toLocaleString());localStorage.setItem("lspd_history",JSON.stringify(h));}

function renderUsers(){
  let users=getUsers();
  let s=document.getElementById("searchUser").value.toLowerCase();
  let f=users.filter(u=>u.username.toLowerCase().includes(s)||u.name.toLowerCase().includes(s));
  f.sort((a,b)=> (posOrder[a.position]||99)-(posOrder[b.position]||99) || (rankOrder[a.rank]||99)-(rankOrder[b.rank]||99));
  document.querySelector("#usersTbl tbody").innerHTML=f.map((u,i)=>`
    <tr><td>${i+1}</td><td>${u.username}</td><td>${u.name}</td>
    <td>${u.role}</td><td>${u.position}</td><td>${u.rank}</td><td>${u.rate}</td>
    <td><button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">❌ Xóa</button></td></tr>`).join("");
}

// ✅ FIXED thêm nhân sự
document.getElementById("addUserForm").addEventListener("submit",e=>{
  e.preventDefault();
  let users=getUsers();
  const u={
    id:Date.now(),
    username:document.getElementById("username").value.trim(),
    password:document.getElementById("password").value,
    name:document.getElementById("name").value.trim(),
    role:document.getElementById("role").value,
    position:document.getElementById("position").value,
    rank:document.getElementById("rank").value,
    rate:Number(document.getElementById("rate").value)
  };
  users.push(u); setUsers(users);
  pushHistory("➕ Thêm "+u.name+" ("+u.username+")");
  e.target.reset(); document.getElementById("rate").value=50;
  renderUsers();
});

function deleteUser(id){let u=getUsers();let t=getTrash();let x=u.find(a=>a.id==id);if(!x)return;t.push(x);setTrash(t);pushHistory("❌ Xóa "+x.name);setUsers(u.filter(a=>a.id!=id));renderUsers();}
function restoreUser(id){let u=getUsers();let t=getTrash();let x=t.find(a=>a.id==id);if(!x)return;u.push(x);setUsers(u);setTrash(t.filter(a=>a.id!=id));pushHistory("♻️ Khôi phục "+x.name);renderUsers();}
function showHistory(){document.getElementById("historyList").innerHTML=getHistory().map(h=>`<li class="list-group-item">${h}</li>`).join("");new bootstrap.Modal(document.getElementById("historyModal")).show();}
function showTrash(){document.getElementById("trashList").innerHTML=getTrash().map(u=>`<tr><td>${u.username}</td><td>${u.name}</td><td>${u.position}</td><td><button class="btn btn-sm btn-success" onclick="restoreUser(${u.id})">Khôi phục</button></td></tr>`).join("");new bootstrap.Modal(document.getElementById("trashModal")).show();}
function exportExcel(){let u=getUsers();if(!u.length)return alert("Chưa có dữ liệu");let d=u.map((x,i)=>({STT:i+1,"Tài khoản":x.username,"Tên":x.name,"Vai trò":x.role,"Chức vụ":x.position,"Quân hàm":x.rank,"Lương/giờ":x.rate}));let ws=XLSX.utils.json_to_sheet(d),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"NhanSu");XLSX.writeFile(wb,"NhanSu.xlsx");}
document.getElementById("searchUser").addEventListener("input",renderUsers);
renderUsers();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!-- ... giữ nguyên phần HTML trước đó ... -->

<div class="table-responsive">
  <table id="usersTbl" class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal sửa -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">✏️ Sửa Nhân Sự</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm" class="row g-3">
          <input type="hidden" id="editId">
          <div class="col-md-6">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" id="editUsername" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Họ và tên sĩ quan</label>
            <input type="text" id="editName" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vai trò</label>
            <select id="editRole" class="form-select">
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Chức vụ</label>
            <select id="editPosition" class="form-select">
              <option value="Giám Đốc">Giám Đốc</option>
              <option value="Phó Giám Đốc">Phó Giám Đốc</option>
              <option value="Trợ Lý Giám Đốc">Trợ Lý Giám Đốc</option>
              <option value="Thư ký">Thư ký</option>
              <option value="Đội trưởng">Đội trưởng</option>
              <option value="Phó đội trưởng">Phó đội trưởng</option>
              <option value="Cảnh sát viên">Cảnh sát viên</option>
              <option value="Thực Tập">Thực Tập</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Quân hàm</label>
            <select id="editRank" class="form-select">
              <option value="Đại tá">Đại tá</option>
              <option value="Thượng tá">Thượng tá</option>
              <option value="Trung tá">Trung tá</option>
              <option value="Thiếu tá">Thiếu tá</option>
              <option value="Đại úy">Đại úy</option>
              <option value="Thượng úy">Thượng úy</option>
              <option value="Trung úy">Trung úy</option>
              <option value="Thiếu úy">Thiếu úy</option>
              <option value="Thượng sĩ">Thượng sĩ</option>
              <option value="Trung sĩ">Trung sĩ</option>
              <option value="Hạ sĩ">Hạ sĩ</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Lương/giờ</label>
            <input type="number" id="editRate" class="form-control" required>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-success">💾 Cập nhật</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function renderUsers(){
  let users=getUsers();
  let s=document.getElementById("searchUser").value.toLowerCase();
  let f=users.filter(u=>u.username.toLowerCase().includes(s)||u.name.toLowerCase().includes(s));
  f.sort((a,b)=> (posOrder[a.position]||99)-(posOrder[b.position]||99) || (rankOrder[a.rank]||99)-(rankOrder[b.rank]||99));
  document.querySelector("#usersTbl tbody").innerHTML=f.map((u,i)=>`
    <tr>
      <td>${i+1}</td><td>${u.username}</td><td>${u.name}</td>
      <td>${u.role}</td><td>${u.position}</td><td>${u.rank}</td><td>${u.rate}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="openEdit(${u.id})">✏️ Sửa</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">❌ Xóa</button>
      </td>
    </tr>`).join("");
}

// Mở modal sửa
function openEdit(id){
  let u=getUsers().find(x=>x.id==id);
  if(!u) return;
  document.getElementById("editId").value=u.id;
  document.getElementById("editUsername").value=u.username;
  document.getElementById("editName").value=u.name;
  document.getElementById("editRole").value=u.role;
  document.getElementById("editPosition").value=u.position;
  document.getElementById("editRank").value=u.rank;
  document.getElementById("editRate").value=u.rate;
  new bootstrap.Modal(document.getElementById("editModal")).show();
}

// Cập nhật nhân sự
document.getElementById("editUserForm").addEventListener("submit",e=>{
  e.preventDefault();
  let users=getUsers();
  let id=parseInt(document.getElementById("editId").value);
  let idx=users.findIndex(x=>x.id==id);
  if(idx>-1){
    users[idx].username=document.getElementById("editUsername").value.trim();
    users[idx].name=document.getElementById("editName").value.trim();
    users[idx].role=document.getElementById("editRole").value;
    users[idx].position=document.getElementById("editPosition").value;
    users[idx].rank=document.getElementById("editRank").value;
    users[idx].rate=Number(document.getElementById("editRate").value);
    setUsers(users);
    pushHistory("✏️ Sửa "+users[idx].name+" ("+users[idx].username+")");
    renderUsers();
    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
  }
});
</script></body><script>
// ================== QUYỀN THEO VAI TRÒ ==================
document.addEventListener("DOMContentLoaded", () => {
  const me = JSON.parse(localStorage.getItem("lspd_me") || "{}");

  // Ẩn menu Quản Lý nếu không phải Admin
  if (me.role !== "Admin") {
    document.querySelectorAll("a, .dropdown-menu a").forEach(link => {
      if (link.textContent.includes("Quản Lý")) {
        link.style.display = "none";
      }
    });
  }

  // Nếu không phải Admin -> ẩn quyền quản lý trong trang
  if (me.role !== "Admin") {
    // Ẩn form thêm
    const addForm = document.getElementById("addUserForm");
    if (addForm) addForm.style.display = "none";

    // Ẩn nút Export, Lịch sử, Thùng rác
    document.querySelectorAll("button").forEach(btn => {
      if (
        btn.textContent.includes("Xuất Excel") ||
        btn.textContent.includes("Lịch Sử") ||
        btn.textContent.includes("Thùng Rác")
      ) {
        btn.style.display = "none";
      }
    });

    // Override renderUsers để xóa quyền Sửa/Xóa
    const oldRender = renderUsers;
    renderUsers = function() {
      oldRender();
      document.querySelectorAll("#usersTbl tbody tr").forEach(tr => {
        const tdAction = tr.querySelector("td:last-child");
        if (tdAction) tdAction.innerHTML = `<span class="text-muted">❌ Không có quyền</span>`;
      });
    };
    renderUsers();
  }
});
</script>
</body>
</html>